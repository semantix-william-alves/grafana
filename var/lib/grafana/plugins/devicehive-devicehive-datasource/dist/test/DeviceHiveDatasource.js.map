{"version":3,"sources":["../../src/DeviceHiveDatasource.js"],"names":["converterManager","DeviceHiveDatasource","instanceSettings","$q","backendSrv","templateSrv","me","q","type","url","name","jsonData","deviceHive","serverUrl","serverURL","login","auth","password","accessToken","refreshToken","options","targetIndexes","Promise","all","targets","filter","target","index","isVisible","hide","push","map","send","_generateRequestObject","maxDataPoints","then","data","results","result","label","dataPath","_processVariables","refId","datapoints","_convertValue","_extractValueByPath","converters","utc","timestamp","format","catch","error","reject","status","message","title","annotation","config","limit","item","annotationObj","time","authenticate","resolve","value","reduce","v","converter","convert","argValues","stringWithVariables","replace","object","path","fields","split","elem","current","forEach","field","allOptions","resultObj","action","deviceId","start","range","from","toDate","getTime","end","to","sortField","sortOrder","take"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAMA,mBAAmB,gCAAzB;;AAGA;;;;;IAIMC,oB;;AAEF;;;;;;;;AAQA,kCAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,UAAlC,EAA8CC,WAA9C,EAA2D;AAAA;;AACvD,YAAMC,KAAK,IAAX;;AAEAA,WAAGC,CAAH,GAAOJ,EAAP;AACAG,WAAGE,IAAH,GAAUN,iBAAiBM,IAA3B;AACAF,WAAGG,GAAH,GAASP,iBAAiBO,GAA1B;AACAH,WAAGI,IAAH,GAAUR,iBAAiBQ,IAA3B;AACAJ,WAAGK,QAAH,GAAcT,iBAAiBS,QAA/B;AACAL,WAAGD,WAAH,GAAiBA,WAAjB;AACAC,WAAGM,UAAH,GAAgB,yBAAe;AAC3BC,uBAAWP,GAAGK,QAAH,CAAYG,SADI;AAE3BC,mBAAOT,GAAGK,QAAH,CAAYK,IAAZ,CAAiBD,KAFG;AAG3BE,sBAAUX,GAAGK,QAAH,CAAYK,IAAZ,CAAiBC,QAHA;AAI3BC,yBAAaZ,GAAGK,QAAH,CAAYK,IAAZ,CAAiBE,WAJH;AAK3BC,0BAAcb,GAAGK,QAAH,CAAYK,IAAZ,CAAiBG;AALJ,SAAf,CAAhB;AAOH;;AAED;;;;;;;;;;8BAMMC,O,EAAS;AACX,gBAAMd,KAAK,IAAX;AACA,gBAAMe,gBAAgB,EAAtB;;AAEA,mBAAOC,QAAQC,GAAR,CAAYH,QAAQI,OAAR,CACVC,MADU,CACH,UAACC,MAAD,EAASC,KAAT,EAAmB;AAC1B,oBAAMC,YAAYF,OAAOG,IAAP,KAAgB,IAAlC;;AAEG,oBAAID,SAAJ,EAAe;AACdP,kCAAcS,IAAd,CAAmBH,KAAnB;AACA;;AAED,uBAAOC,SAAP;AACH,aATU,EAUVG,GAVU,CAUN;AAAA,uBAAUzB,GAAGM,UAAH,CAAcoB,IAAd,CAAmB1B,GAAG2B,sBAAH,CAA0BP,MAA1B,EAAkCN,OAAlC,EAA2CA,QAAQc,aAAnD,CAAnB,CAAV;AAAA,aAVM,CAAZ,EAWFC,IAXE,CAWG,mBAAW;AACb,uBAAO;AACHC,0BAAMC,QAAQN,GAAR,CAAY,UAACO,MAAD,EAASX,KAAT,EAAmB;AACjC,4BAAMnB,OAAOY,QAAQI,OAAR,CAAgBH,cAAcM,KAAd,CAAhB,EAAsCnB,IAAnD;AACA,4BAAM+B,QAAQnB,QAAQI,OAAR,CAAgBH,cAAcM,KAAd,CAAhB,EAAsCY,KAApD;AACA,4BAAMC,WAAWlC,GAAGmC,iBAAH,CAAqBrB,QAAQI,OAAR,CAAgBH,cAAcM,KAAd,CAAhB,EAAsCa,QAA3D,CAAjB;AACA,4BAAME,QAAQtB,QAAQI,OAAR,CAAgBH,cAAcM,KAAd,CAAhB,EAAsCe,KAApD;;AAEA,+BAAO;AACHhB,oCAAQa,cAAY/B,IAAZ,GAAmBkC,KADxB;AAEHC,wCAAYL,OAAU9B,IAAV,QAAmBuB,GAAnB,CAAuB,kBAAU;AACzC,uCAAO,CACHzB,GAAGsC,aAAH,CAAiBtC,GAAGuC,mBAAH,CAAuBnB,MAAvB,EAA+Bc,QAA/B,CAAjB,EAA2DpB,QAAQI,OAAR,CAAgBH,cAAcM,KAAd,CAAhB,EAAsCmB,UAAjG,CADG,EAEH,CAAC,iBAAOC,GAAP,CAAWrB,OAAOsB,SAAlB,EAA6BC,MAA7B,KAFE,CAAP;AAIH,6BALW;AAFT,yBAAP;AASH,qBAfK;AADH,iBAAP;AAkBH,aA9BE,EA+BFC,KA/BE,CA+BI,UAACC,KAAD;AAAA,uBAAW7C,GAAGC,CAAH,CAAK6C,MAAL,CAAY,EAAEC,eAAF,EAAmBC,SAASH,KAA5B,EAAmCI,cAAnC,EAAZ,CAAX;AAAA,aA/BJ,CAAP;AAgCH;;AAED;;;;;;;;wCAKgBnC,O,EAAS;AACrB,gBAAMd,KAAK,IAAX;;AAEA,mBAAOA,GAAGM,UAAH,CAAcoB,IAAd,CAAmB1B,GAAG2B,sBAAH,CAClBb,QAAQoC,UAAR,CAAmBC,MADD,EACSrC,OADT,EACkBA,QAAQoC,UAAR,CAAmBE,KADrC,CAAnB,EAEFvB,IAFE,CAEG,kBAAU;AACZ,oBAAM3B,OAAOY,QAAQoC,UAAR,CAAmBC,MAAnB,CAA0BjD,IAAvC;AACA,oBAAMgC,WAAWlC,GAAGmC,iBAAH,CAAqBrB,QAAQoC,UAAR,CAAmBC,MAAnB,CAA0BjB,QAA/C,CAAjB;;AAEA,uBAAOF,OAAU9B,IAAV,QAAmBuB,GAAnB,CAAuB,UAAC4B,IAAD,EAAU;AACpC,wBAAMC,gBAAgBtD,GAAGuC,mBAAH,CAAuBc,IAAvB,EAA6BnB,QAA7B,CAAtB;AACAoB,kCAAcJ,UAAd,GAA2BpC,QAAQoC,UAAnC;AACAI,kCAAcC,IAAd,GAAqBD,cAAcC,IAAd,IAAsB,CAAC,iBAAOd,GAAP,CAAWY,KAAKX,SAAhB,EAA2BC,MAA3B,KAA5C;;AAEA,2BAAOW,aAAP;AACH,iBANM,CAAP;AAOH,aAbE,EAcFV,KAdE,CAcI,UAACC,KAAD;AAAA,uBAAW7C,GAAGC,CAAH,CAAK6C,MAAL,CAAY,EAAEC,eAAF,EAAmBC,SAASH,KAA5B,EAAmCI,cAAnC,EAAZ,CAAX;AAAA,aAdJ,CAAP;AAeH;;AAED;;;;;;;;yCAKiB;AACb,gBAAMjD,KAAK,IAAX;;AAEA,mBAAOA,GAAGM,UAAH,CAAckD,YAAd,GACF3B,IADE,CACG;AAAA,uBAAMb,QAAQyC,OAAR,CAAgB,EAAEV,iBAAF,EAAqBC,iCAArB,EAAwDC,gBAAxD,EAAhB,CAAN;AAAA,aADH,EAEFL,KAFE,CAEI,UAACC,KAAD;AAAA,uBAAW7C,GAAGC,CAAH,CAAK6C,MAAL,CAAY,EAAEC,eAAF,EAAmBC,SAASH,KAA5B,EAAmCI,cAAnC,EAAZ,CAAX;AAAA,aAFJ,CAAP;AAGH;;AAED;;;;;;;;;sCAMcS,K,EAAOlB,U,EAAY;AAC7B,mBAAOA,WAAWmB,MAAX,CAAkB,UAACC,CAAD,EAAIC,SAAJ;AAAA,uBACrBnE,iBAAiBoE,OAAjB,CAAyBD,UAAUzD,IAAnC,EAAyCwD,CAAzC,EAA4CC,UAAUE,SAAtD,CADqB;AAAA,aAAlB,EAC+DL,KAD/D,CAAP;AAEH;;AAED;;;;;;;;;0CAMkBM,mB,EAAqB;AACnC,gBAAMhE,KAAK,IAAX;;AAEA,mBAAOA,GAAGD,WAAH,CAAekE,OAAf,MAA0BD,mBAA1B,CAAP;AACH;;AAED;;;;;;;;;;4CAOoBE,M,EAAQC,I,EAAM;AAC9B,gBAAMC,SAASD,KAAKE,KAAL,CAAW,UAAX,EAAuBlD,MAAvB,CAA8B;AAAA,uBAAQmD,WAAR;AAAA,aAA9B,CAAf;AACA,gBAAIC,UAAUL,MAAd;;AAEAE,mBAAOI,OAAP,CAAe;AAAA,uBAASD,UAAUA,WAAWA,QAAQE,KAAR,CAAX,GAA4BF,QAAQE,KAAR,CAA5B,GAA6C,IAAhE;AAAA,aAAf;;AAEA,mBAAOF,OAAP;AACH;;AAED;;;;;;;;;;;+CAQuBnD,M,EAAQsD,U,EAAYtB,K,EAAO;AAC9C,gBAAMpD,KAAK,IAAX;AACA,gBAAM2E,YAAY;AACdC,wBAAWxD,OAAOlB,IAAlB,UADc;AAEd2E,0BAAU7E,GAAGK,QAAH,CAAYwE,QAFR;AAGdC,uBAAOJ,WAAWK,KAAX,CAAiBC,IAAjB,CAAsBC,MAAtB,GAA+BC,OAA/B,EAHO;AAIdC,qBAAKT,WAAWK,KAAX,CAAiBK,EAAjB,CAAoBH,MAApB,GAA6BC,OAA7B,EAJS;AAKdG,sCALc;AAMdC,gCANc;AAOdC,sBAAMnC,SAAS;AAPD,aAAlB;;AAUAuB,sBAAUvD,OAAOlB,IAAjB,IAAyBF,GAAGmC,iBAAH,CAAqBf,OAAOhB,IAA5B,CAAzB;;AAEA,mBAAOuE,SAAP;AACH;;;;;;kBAIUhF,oB","file":"DeviceHiveDatasource.js","sourcesContent":["import moment from 'moment';\r\nimport DeviceHive from './DeviceHive';\r\nimport ConverterManager from './ConverterManager.js';\r\n\r\nconst converterManager = new ConverterManager();\r\n\r\n\r\n/**\r\n * DeviceHive datasource class\r\n * Datasource object communicates with the database and transforms data to times series.\r\n */\r\nclass DeviceHiveDatasource {\r\n\r\n    /**\r\n     * Creates an instance of DeviceHiveDatasource.\r\n     * @param {Object} instanceSettings\r\n     * @param {any} $q\r\n     * @param backendSrv\r\n     * @param templateSrv\r\n     * @memberof DeviceHiveDatasource\r\n     */\r\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n        const me = this;\r\n\r\n        me.q = $q;\r\n        me.type = instanceSettings.type;\r\n        me.url = instanceSettings.url;\r\n        me.name = instanceSettings.name;\r\n        me.jsonData = instanceSettings.jsonData;\r\n        me.templateSrv = templateSrv;\r\n        me.deviceHive = new DeviceHive({\r\n            serverUrl: me.jsonData.serverURL,\r\n            login: me.jsonData.auth.login,\r\n            password: me.jsonData.auth.password,\r\n            accessToken: me.jsonData.auth.accessToken,\r\n            refreshToken: me.jsonData.auth.refreshToken,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Function used by Grafana to query data\r\n     * @param {Object} options\r\n     * @returns\r\n     * @memberof DeviceHiveDatasource\r\n     */\r\n    query(options) {\r\n        const me = this;\r\n        const targetIndexes = [];\r\n\r\n        return Promise.all(options.targets\r\n                .filter((target, index) => {\r\n\t                const isVisible = target.hide !== true;\r\n\r\n                    if (isVisible) {\r\n\t                    targetIndexes.push(index);\r\n                    }\r\n\r\n                    return isVisible;\r\n                })\r\n                .map(target => me.deviceHive.send(me._generateRequestObject(target, options, options.maxDataPoints))))\r\n            .then(results => {\r\n                return {\r\n                    data: results.map((result, index) => {\r\n                        const type = options.targets[targetIndexes[index]].type;\r\n                        const label = options.targets[targetIndexes[index]].label;\r\n                        const dataPath = me._processVariables(options.targets[targetIndexes[index]].dataPath);\r\n                        const refId = options.targets[targetIndexes[index]].refId;\r\n\r\n                        return {\r\n                            target: label || `${type}${refId}`,\r\n                            datapoints: result[`${type}s`].map(target => {\r\n                                return [\r\n                                    me._convertValue(me._extractValueByPath(target, dataPath), options.targets[targetIndexes[index]].converters),\r\n                                    +moment.utc(target.timestamp).format(`x`)\r\n                                ]\r\n                            })\r\n                        };\r\n                    })\r\n                }\r\n            })\r\n            .catch((error) => me.q.reject({ status: `error`, message: error, title: `Error` }));\r\n    }\r\n\r\n    /**\r\n     * Used by dashboards to get annotations\r\n     * @param options\r\n     * @returns {Promise}\r\n     */\r\n    annotationQuery(options) {\r\n        const me = this;\r\n\r\n        return me.deviceHive.send(me._generateRequestObject(\r\n                options.annotation.config, options, options.annotation.limit))\r\n            .then(result => {\r\n                const type = options.annotation.config.type;\r\n                const dataPath = me._processVariables(options.annotation.config.dataPath);\r\n\r\n                return result[`${type}s`].map((item) => {\r\n                    const annotationObj = me._extractValueByPath(item, dataPath);\r\n                    annotationObj.annotation = options.annotation;\r\n                    annotationObj.time = annotationObj.time || +moment.utc(item.timestamp).format(`x`);\r\n\r\n                    return annotationObj;\r\n                });\r\n            })\r\n            .catch((error) => me.q.reject({ status: `error`, message: error, title: `Error` }));\r\n    }\r\n\r\n    /**\r\n     * Function used by Grafana to test datasource\r\n     * @returns\r\n     * @memberof DeviceHiveDatasource\r\n     */\r\n    testDatasource() {\r\n        const me = this;\r\n\r\n        return me.deviceHive.authenticate()\r\n            .then(() => Promise.resolve({ status: `success`, message: `Data source is working`, title: `Success` }))\r\n            .catch((error) => me.q.reject({ status: `error`, message: error, title: `Error` }));\r\n    }\r\n\r\n    /**\r\n     * Converting value by ConverterManager\r\n     * @param value\r\n     * @param converters\r\n     * @private\r\n     */\r\n    _convertValue(value, converters) {\r\n        return converters.reduce((v, converter) =>\r\n            converterManager.convert(converter.name, v, converter.argValues), value);\r\n    }\r\n\r\n    /**\r\n     * Transform template variable to it's values\r\n     * @param stringWithVariables\r\n     * @return {*}\r\n     * @private\r\n     */\r\n    _processVariables(stringWithVariables) {\r\n        const me = this;\r\n\r\n        return me.templateSrv.replace(`${stringWithVariables}`);\r\n    }\r\n\r\n    /**\r\n     * Internal function to extract value from object based on path\r\n     * @param {Object} object\r\n     * @param {String} path\r\n     * @returns\r\n     * @memberof DeviceHive\r\n     */\r\n    _extractValueByPath(object, path) {\r\n        const fields = path.split(/[\\.\\[\\]]/).filter(elem => elem !== ``);\r\n        let current = object;\r\n\r\n        fields.forEach(field => current = current && current[field] ? current[field] : null);\r\n\r\n        return current;\r\n    }\r\n\r\n    /**\r\n     * Generate DeviceHive WS request object\r\n     * @param target\r\n     * @param allOptions\r\n     * @param limit\r\n     * @returns {Object}\r\n     * @private\r\n     */\r\n    _generateRequestObject(target, allOptions, limit) {\r\n        const me = this;\r\n        const resultObj = {\r\n            action: `${target.type}/list`,\r\n            deviceId: me.jsonData.deviceId,\r\n            start: allOptions.range.from.toDate().getTime(),\r\n            end: allOptions.range.to.toDate().getTime(),\r\n            sortField: `timestamp`,\r\n            sortOrder: `ASC`,\r\n            take: limit || 100\r\n        };\r\n\r\n        resultObj[target.type] = me._processVariables(target.name);\r\n\r\n        return resultObj;\r\n    }\r\n}\r\n\r\n\r\nexport default DeviceHiveDatasource\r\n"]}