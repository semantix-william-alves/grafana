{"version":3,"sources":["../src/datasource.js"],"names":["_","VariablesHelper","Capabilities","QueryProcessor","tagsModelToString","modelToString","HawkularDatasource","instanceSettings","$q","backendSrv","templateSrv","type","metricsUrl","url","alertsUrl","name","tenant","jsonData","isTenantPerQuery","authorization","basicAuth","length","token","q","typeResources","variablesHelper","capabilitiesPromise","queryVersion","then","version","queryProcessor","multiTenantsQuery","bind","headers","tenants","params","data","method","all","map","datasourceRequest","getHeaders","result","response","status","options","validTargets","targets","filter","target","hide","sanitizeTarget","id","undefined","tags","tagsQL","when","promises","run","flatten","responses","sort","m1","m2","localeCompare","stats","rate","seriesAggFn","raw","timeAggFn","endpoint","message","title","metricIds","resolve","annotation","query","queryAlerts","start","range","from","valueOf","end","to","order","ids","allAnnotations","metrics","forEach","metric","annot","time","dp","timestamp","text","value","push","key","hasOwnProperty","replace","join","startTime","endTime","triggerIds","events","event","ctime","resolveForQL","getTargetTenants","multiTenantsData","tenantData","Object","keys","mergedTags","tag","substr","findTags","trim","charAt","runWithResolvedVariables","p","pattern","flatTags","property","concat","func","resolved","catch"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport {VariablesHelper} from './variablesHelper';\nimport {Capabilities} from './capabilities';\nimport {QueryProcessor} from './queryProcessor';\nimport {modelToString as tagsModelToString} from './tagsKVPairsController';\n\nexport class HawkularDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.metricsUrl = instanceSettings.url + '/metrics';\n    this.alertsUrl = instanceSettings.url + '/alerts';\n    this.name = instanceSettings.name;\n    this.tenant = instanceSettings.jsonData.tenant;\n    this.isTenantPerQuery = instanceSettings.jsonData.isTenantPerQuery;\n    this.authorization = null;\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.authorization = instanceSettings.basicAuth;\n    } else if (typeof instanceSettings.jsonData.token === 'string' && instanceSettings.jsonData.token.length > 0) {\n      this.authorization = 'Bearer ' + instanceSettings.jsonData.token;\n    }\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.typeResources = {\n      'gauge': 'gauges',\n      'counter': 'counters',\n      'availability': 'availability'\n    };\n    this.variablesHelper = new VariablesHelper(templateSrv);\n    this.capabilitiesPromise = this.queryVersion().then(version => new Capabilities(version));\n    this.queryProcessor = new QueryProcessor($q, this.multiTenantsQuery.bind(this), this.variablesHelper, this.capabilitiesPromise, this.metricsUrl,\n            this.typeResources);\n  }\n\n  getHeaders(tenant) {\n    const headers = {\n      'Content-Type': 'application/json'\n    }\n    if (tenant && this.isTenantPerQuery) {\n      headers['Hawkular-Tenant'] = tenant;\n    } else {\n      headers['Hawkular-Tenant'] = this.tenant;\n    }\n    if (this.authorization) {\n      headers['Authorization'] = this.authorization;\n    }\n    return headers;\n  }\n\n  multiTenantsQuery(tenants, url, params, data, method) {\n    return this.q.all(tenants.map(tenant => {\n      return this.backendSrv.datasourceRequest({\n        url: url,\n        params: params,\n        data: data,\n        method: method,\n        headers: this.getHeaders(tenant)\n      }).then(response => {\n        return {\n          tenant: tenant,\n          result: (response.status == 200) ? response.data : null\n        }\n      });\n    }));\n  }\n\n  query(options) {\n    const validTargets = options.targets\n      .filter(target => !target.hide)\n      .map(this.sanitizeTarget)\n      .filter(target => target.id !== undefined\n         || (target.tags !== undefined && target.tags.length > 0)\n         || (target.tagsQL !== undefined && target.tagsQL.length > 0));\n\n    if (validTargets.length === 0) {\n      return this.q.when({data: []});\n    }\n\n    const promises = validTargets.map(target => this.queryProcessor.run(target, options));\n\n    return this.q.all(promises)\n      .then(responses => ({data: _.flatten(responses).sort((m1, m2) => m1.target.localeCompare(m2.target))}));\n  }\n\n  sanitizeTarget(target) {\n    // Create sane target, providing backward compatibility\n    if (target.id === undefined && target.target !== 'select metric') {\n      target.id = target.target;\n    } else if (target.id === '-- none --') {\n      delete target.id;\n    }\n    delete target.target;\n    target.stats = target.stats || [];\n    target.type = target.type || 'gauge';\n    target.rate = target.rate === true;\n    target.tags = target.tags || [];\n    target.tagsQL = target.tagsQL || '';\n    target.seriesAggFn = target.seriesAggFn || 'none';\n    if (target.raw === undefined) {\n      // Compatibility note: previously default was timeAggFn=avg and seriesAggFn=none\n      if (target.seriesAggFn === 'none' && target.timeAggFn === 'avg') {\n        delete target.timeAggFn;\n      }\n      target.raw = (target.timeAggFn === undefined);\n    }\n    return target;\n  }\n\n  testDatasource() {\n    // If tenants is unknown at this point (when having per-query tenants)\n    // We do a more basic check to / endpoint, which checks authentication in basic-auth mode but not with token/OpenShift\n    // Else, it's full connectivity with tenant check\n    const endpoint = this.isTenantPerQuery ? '/' : '/metrics';\n    return this.backendSrv.datasourceRequest({\n      url: this.metricsUrl + endpoint,\n      method: 'GET',\n      headers: this.getHeaders()\n    }).then(response => {\n      if (response.status === 200 || response.status === 204) {\n        return { status: 'success', message: 'Data source is working', title: 'Success' };\n      } else {\n        return { status: 'error', message: `Connection failed (${response.status})`, title: 'Error' };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    const metricIds = this.variablesHelper.resolve(options.annotation.query, options);\n    if (options.annotation.type === 'alert') {\n      return this.queryAlerts(metricIds, options);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/${options.annotation.type}/raw/query`,\n      data: {\n        start: options.range.from.valueOf(),\n        end: options.range.to.valueOf(),\n        order: 'ASC',\n        ids: metricIds\n      },\n      method: 'POST',\n      headers: this.getHeaders(options.annotation.tenant)\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(metrics => {\n      let allAnnotations = [];\n      metrics.forEach(metric => {\n        metric.data.forEach(dp => {\n          let annot = {\n            annotation: options.annotation,\n            time: dp.timestamp,\n            title: options.annotation.name,\n            text: dp.value\n          };\n          let tags = [];\n          if (metricIds.length > 1) {\n            tags.push(metric.id);\n          }\n          if (dp.tags) {\n            for (let key in dp.tags) {\n              if (dp.tags.hasOwnProperty(key)) {\n                tags.push(dp.tags[key].replace(' ', '_'));\n              }\n            }\n          }\n          if (tags.length > 0) {\n            annot.tags = tags.join(' ');\n          }\n          allAnnotations.push(annot);\n        });\n      });\n      return allAnnotations;\n    });\n  }\n\n  queryAlerts(ids, options) {\n    return this.backendSrv.datasourceRequest({\n      url: `${this.alertsUrl}/events`,\n      params: {\n        startTime: options.range.from.valueOf(),\n        endTime: options.range.to.valueOf(),\n        triggerIds: ids\n      },\n      method: 'GET',\n      headers: this.getHeaders(options.annotation.tenant)\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(events => {\n      return events.map(event => {\n        return {\n          annotation: options.annotation,\n          time: event.ctime,\n          title: options.annotation.name,\n          text: event.text,\n          tags: event.status\n        };\n      });\n    });\n  }\n\n  getTargetTenants(target) {\n    if (target.tenant) {\n      return this.variablesHelper.resolve(target.tenant, {});\n    }\n    return [null];\n  }\n\n  suggestMetrics(target) {\n    let url = this.metricsUrl + '/metrics?type=' + target.type;\n    if (target.tagsQL && target.tagsQL.length > 0) {\n      url += '&tags=' + this.variablesHelper.resolveForQL(target.tagsQL, {});\n    } else if (target.tags && target.tags.length > 0) {\n      url += '&tags=' + tagsModelToString(target.tags, this.variablesHelper, {});\n    }\n    const tenants = this.getTargetTenants(target);\n    return this.multiTenantsQuery(tenants, url, null, null, 'GET')\n      .then(multiTenantsData => {\n        // Eliminate possible duplicates from multi-tenancy\n        let ids = {};\n        multiTenantsData.forEach(tenantData => {\n          if (tenantData.result) {\n            tenantData.result.forEach(metric => {\n              ids[metric.id] = true;\n            });\n          }\n        });\n        return Object.keys(ids)\n          .sort()\n          .map(id => {\n            return {text: id, value: id};\n          });\n      });\n  }\n\n  suggestTags(target, key) {\n    if (!key) {\n      return this.q.when([]);\n    }\n    const tenants = this.getTargetTenants(target);\n    const url = `${this.metricsUrl}/${this.typeResources[target.type]}/tags/${key}:*`;\n    return this.multiTenantsQuery(tenants, url, null, null, 'GET')\n      .then(multiTenantsData => {\n        // Eliminate possible duplicates from multi-tenancy\n        let mergedTags = {};\n        multiTenantsData.forEach(tenantData => {\n          if (tenantData.result) {\n            if (tenantData.result.hasOwnProperty(key)) {\n              tenantData.result[key].forEach(tag => {\n                mergedTags[tag] = true;\n              });\n            }\n          }\n        });\n        return Object.keys(mergedTags)\n          .sort()\n          .map(tag => {\n            return {text: tag, value: tag};\n          });\n      });\n  }\n\n  suggestTagKeys(target) {\n    const tenants = this.getTargetTenants(target);\n    return this.multiTenantsQuery(tenants, this.metricsUrl + '/metrics/tags', null, null, 'GET')\n      .then(multiTenantsData => {\n        // Eliminate possible duplicates from multi-tenancy\n        let mergedTags = {};\n        multiTenantsData.forEach(tenantData => {\n          if (tenantData.result) {\n            tenantData.result.forEach(tag => {\n              mergedTags[tag] = true;\n            });\n          }\n        });\n        return Object.keys(mergedTags)\n          .map(tag => {\n            return {text: tag, value: tag};\n          });\n      });\n  }\n\n  metricFindQuery(query) {\n    let params = '';\n    if (query !== undefined) {\n      if (query.substr(0, 5) === 'tags/') {\n        return this.findTags(query.substr(5).trim());\n      }\n      if (query.charAt(0) === '?') {\n        params = query;\n      } else {\n        params = '?' + query;\n      }\n    }\n    return this.runWithResolvedVariables(params, p => this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/metrics${p}`,\n      method: 'GET',\n      headers: this.getHeaders()\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    }));\n  }\n\n  findTags(pattern) {\n    return this.runWithResolvedVariables(pattern, p => this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/metrics/tags/${p}`,\n      method: 'GET',\n      headers: this.getHeaders()\n    }).then(result => {\n      let flatTags = [];\n      if (result.data) {\n        let data = result.data;\n        for (let property in data) {\n          if (data.hasOwnProperty(property)) {\n            flatTags = flatTags.concat(data[property]);\n          }\n        }\n      }\n      return flatTags.map(tag => {\n        return {text: tag, value: tag};\n      });\n    }));\n  }\n\n  runWithResolvedVariables(target, func) {\n    const resolved = this.variablesHelper.resolve(target, {});\n    return this.q.all(resolved.map(p => func(p)))\n      .then(result => _.flatten(result));\n  }\n\n  queryVersion() {\n    return this.backendSrv.datasourceRequest({\n      url: this.metricsUrl + '/status',\n      method: 'GET',\n      headers: {'Content-Type': 'application/json'}\n    }).then(response => response.data['Implementation-Version'])\n    .catch(response => 'Unknown');\n  }\n\n  getCapabilities() {\n    return this.capabilitiesPromise;\n  }\n}\n"]}