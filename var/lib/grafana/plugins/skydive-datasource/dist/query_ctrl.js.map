{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","SkydiveDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","flowMetrics","target","metricField","metricFields","dedupFlow","text","value","dedupIntf","dedup","aggregates","mode","prevWorked","prevTitle","prevGremlin","prevMetricField","prevDedup","prevAggregates","prevMode","onChangeInternal","gremlin","range","panelCtrl","query","datasource","targetToQuery","title","q","from","format","to","doGremlinQuery","then","result","status","data","length","_","forEach","metrics","uuid","forOwn","metric","key","push","refresh","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nexport class SkydiveDatasourceQueryCtrl extends QueryCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n\n    // set visibility of some field depending on the type of metrics returned\n    this.flowMetrics = false;\n\n    this.target.metricField = this.target.metricField || \"Bytes\";\n\n    // TODO(safchain) request datasource to get metrics fields dynamically\n    this.metricFields = [];\n\n    this.dedupFlow = [\n      {text: \"---\", value: \"---\"},\n      {text: \"LayersPath\", value: \"LayersPath\"},\n      {text: \"Application\", value: \"Application\"},\n      {text: \"TrackingID\", value: \"TrackingID\"},\n      {text: \"ParentUUID\", value: \"ParentUUID\"},\n      {text: \"NodeTID\", value: \"NodeTID\"},\n      {text: \"ANodeTID\", value: \"ANodeTID\"},\n      {text: \"BNodeTID\", value: \"BNodeTID\"}\n    ];\n\n    this.dedupIntf = [\n      {text: \"---\", value: \"---\"},\n      {text: \"ID\", value: \"ID\"},\n      {text: \"TID\", value: \"TID\"},\n      {text: \"Type\", value: \"Type\"}\n    ];\n\n    this.target.dedup = this.target.dedup || \"---\";\n    this.dedup = this.dedupFlow;\n\n    this.target.aggregates = this.target.aggregates || false;\n\n    this.target.mode = this.target.mode || \"All\";\n    this.mode = [\n      {text: \"All\", value: \"All\"},\n      {text: \"Outer only\", value: \"Outer\"},\n      {text: \"Inner only\", value: \"Inner\"}\n    ];\n\n    this.prevWorked = false;\n    this.prevTitle = \"\";\n    this.prevGremlin = \"\";\n    this.prevMetricField = this.metricField;\n    this.prevDedup = this.dedup;\n    this.prevAggregates = this.aggregates;\n    this.prevMode = this.mode;\n\n    this.onChangeInternal();\n  }\n\n  getCollapsedText() {\n    return this.target.gremlin;\n  }\n\n  onChangeInternal() {\n    var range = this.panelCtrl.range;\n\n    var query = this.datasource.targetToQuery(this.target, 1, 2);\n\n    if (!this.prevWorked || this.prevGremlin != query.gremlin || this.prevMetricField != this.target.metricField ||\n        this.prevAggregates != this.target.aggregates || this.prevMode != this.target.mode ||\n        this.prevTitle != this.target.title) {\n\n      this.prevWorked = false;\n\n      // flow metrics ?\n      var flowMetrics = false;\n\n      var target = {\n        gremlin: this.target.gremlin\n      };\n\n      var q = this.datasource.targetToQuery(target, range.from.format('X'), range.to.format('X'));\n      this.datasource.doGremlinQuery(q.gremlin).then(result => {\n        if (result.status === 200 && result.data.length > 0) {\n          this.prevWorked = true;\n\n          this.metricFields = [\n            {text: \"Bytes\", value: \"Bytes\"},\n            {text: \"Packets\", value: \"Packets\"},\n          ];\n          this.prevMetricField = this.target.metricField;\n\n          _.forEach(result.data[0], (metrics, uuid) => {\n            _.forEach(metrics, metric => {\n              _.forOwn(metric, (value, key) => {\n                if (key == \"ABBytes\") {\n                  flowMetrics = true;\n                }\n                this.metricFields.push({text: key, value: key});\n              });\n\n              return false;\n            });\n            return false;\n          });\n        }\n\n        if (flowMetrics) {\n          this.dedup = this.dedupFlow;\n        } else {\n          this.dedup = this.dedupIntf;\n        }\n        if (this.flowMetrics != flowMetrics) {\n          this.flowMetrics = flowMetrics;\n\n          // reset the metricField as we changed of type of metrics\n          this.target.metricField = \"Bytes\";\n        }\n\n        this.prevTitle = this.target.title;\n        this.prevGremlin = query.gremlin;\n        this.prevMetricField = this.target.metricField;\n        this.prevDedup = this.target.dedup;\n        this.prevAggregates = this.target.aggregates;\n        this.prevMode = this.target.mode;\n\n        this.panelCtrl.refresh();\n      });\n    }\n  }\n}\n\nSkydiveDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}