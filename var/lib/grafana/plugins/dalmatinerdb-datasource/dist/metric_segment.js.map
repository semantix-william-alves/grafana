{"version":3,"sources":["../src/metric_segment.js"],"names":["_","$","angular","mod","module","filter","$sce","values","type","forEach","v","html","getTrustedHtml","directive","$compile","inputTemplate","linkTemplate","selectTemplate","restrict","scope","segment","getOptions","onChange","useHtmlLabel","link","$scope","elem","attrs","$input","$button","styleMode","options","cancelBlur","linkMode","appendTo","updateVariableValue","value","$apply","selected","find","altSegments","fake","expandable","custom","trustAsHtml","switchToLink","fromClick","clearTimeout","hide","show","val","inputBlur","setTimeout","source","query","callback","then","map","alt","indexOf","unshift","data","$menu","each","$el","item","text","updater","focus","matcher","str","substring","length","toLowerCase","match","e","attr","typeahead","minLength","items","lookup","$element","proxy","process","keydown","evt","keyCode","click","css","width","blur","contents"],"mappings":"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","file":"metric_segment.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport angular from 'angular';\n\n// Component copied from: grafana/public/app/core/directives/metric_segment.js\n\nvar mod = angular.module('grafana.directives');\n\nmod.filter('to_trusted', [\n    '$sce',\n    function($sce) {\n      return function(values, type) {\n        values.forEach(v => v.html = $sce.getTrustedHtml(v.html));\n        return values;\n      }\n    }\n]);\n\nmod.directive('dalmatinerMetricSegment', function($compile, $sce) {\n    var inputTemplate = '<input type=\"text\" data-provide=\"typeahead\" ' +\n      ' class=\"gf-form-input input-medium\"' +\n      ' spellcheck=\"false\" style=\"display:none\"></input>';\n\n    var linkTemplate = '<a class=\"gf-form-label\" ng-class=\"segment.cssClass\" ' +\n      'tabindex=\"1\" give-focus=\"segment.focus\" ng-bind-html=\"segment.html\"></a>';\n\n    var selectTemplate = '<a class=\"gf-form-input gf-form-input--dropdown\" ng-class=\"segment.cssClass\" ' +\n      'tabindex=\"1\" give-focus=\"segment.focus\" ng-bind-html=\"segment.html\"></a>';\n\n    return {\n      restrict: 'E',\n      scope: {\n        segment: \"=\",\n        getOptions: \"&\",\n        onChange: \"&\",\n        useHtmlLabel: \"&\"\n      },\n      link: function($scope, elem, attrs) {\n        var $input = $(inputTemplate);\n        var $button = $(attrs.styleMode === 'select' ? selectTemplate : linkTemplate);\n        var segment = $scope.segment;\n        var options = null;\n        var cancelBlur = null;\n        var linkMode = true;\n\n        $input.appendTo(elem);\n        $button.appendTo(elem);\n\n        $scope.updateVariableValue = function(value) {\n          if (value === '' || segment.value === value) {\n            return;\n          }\n\n          $scope.$apply(function() {\n            var selected = _.find($scope.altSegments, { value: value });\n            if (selected) {\n              segment.value = selected.value;\n              segment.html = selected.html;\n              segment.fake = false;\n              segment.expandable = selected.expandable;\n            }\n            else if (segment.custom !== 'false') {\n              segment.value = value;\n              segment.html = $sce.trustAsHtml(value);\n              segment.expandable = true;\n              segment.fake = false;\n            }\n\n            $scope.onChange();\n          });\n        };\n\n        $scope.switchToLink = function(fromClick) {\n          if (linkMode && !fromClick) { return; }\n\n          clearTimeout(cancelBlur);\n          cancelBlur = null;\n          linkMode = true;\n          $input.hide();\n          $button.show();\n          $scope.updateVariableValue($input.val());\n        };\n\n        $scope.inputBlur = function() {\n          // happens long before the click event on the typeahead options\n          // need to have long delay because the blur\n          cancelBlur = setTimeout($scope.switchToLink, 200);\n        };\n\n        $scope.source = function(query, callback) {\n          if (options) { return options; }\n\n          $scope.$apply(function() {\n            $scope.getOptions().then(function(altSegments) {\n              $scope.altSegments = altSegments;\n              options = _.map($scope.altSegments, function(alt) { return alt.value; });\n\n              // add custom values\n              if (segment.custom !== 'false') {\n                if (!segment.fake && _.indexOf(options, segment.value) === -1) {\n                  options.unshift(segment.value);\n                }\n              }\n\n              callback(options);\n\n              // Change the label options to the html values\n              if ($scope.useHtmlLabel) {\n\n                $input.data('typeahead').$menu.find('a').each(function () {\n                  var $el = $(this);\n                  var item = _.find($scope.altSegments, {value: $el.text()});\n                  if (item) {\n                    $el.text(item.html);\n                  }\n                })\n              }\n            });\n          });\n        };\n\n        $scope.updater = function(value) {\n          if (value === segment.value) {\n            clearTimeout(cancelBlur);\n            $input.focus();\n            return value;\n          }\n\n          $input.val(value);\n          $scope.switchToLink(true);\n\n          return value;\n        };\n\n        $scope.matcher = function(item) {\n          var str = this.query;\n          if (str[0] === '/') { str = str.substring(1); }\n          if (str[str.length - 1] === '/') { str = str.substring(0, str.length-1); }\n          try {\n            return item.toLowerCase().match(str);\n          } catch(e) {\n            return false;\n          }\n        };\n\n        $input.attr('data-provide', 'typeahead');\n        $input.typeahead({ source: $scope.source, minLength: 0, items: 10000, updater: $scope.updater, matcher: $scope.matcher });\n\n        var typeahead = $input.data('typeahead');\n        typeahead.lookup = function () {\n          this.query = this.$element.val() || '';\n          var items = this.source(this.query, $.proxy(this.process, this));\n          return items ? this.process(items) : items;\n        };\n\n        $button.keydown(function(evt) {\n          // trigger typeahead on down arrow or enter key\n          if (evt.keyCode === 40 || evt.keyCode === 13) {\n            $button.click();\n          }\n        });\n\n        $button.click(function() {\n          options = null;\n          $input.css('width', ($button.width() + 16) + 'px');\n\n          $button.hide();\n          $input.show();\n          $input.focus();\n\n          linkMode = false;\n\n          var typeahead = $input.data('typeahead');\n          if (typeahead) {\n            $input.val('');\n            typeahead.lookup();\n          }\n        });\n\n        $input.blur($scope.inputBlur);\n\n\n        $compile(elem.contents())($scope);\n      }\n    };\n  });\n"]}