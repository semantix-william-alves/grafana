{"version":3,"sources":["../src/heatmapControl.js"],"names":["ensureArrayContains","array","value","indexOf","push","colorToHex","color","substr","digits","replace","split","length","red","parseInt","green","blue","rgba","toString","getColorByXPercentage","canvas","xPercent","x","width","context","getContext","p","getImageData","data","TimeSeries","kbn","MetricsPanelCtrl","heatmapEditor","displayEditor","pluginName","_","moment","panelOptions","aggregationFunctions","treeMap","modes","timestampFormats","panelDefaults","seriesOverrides","thresholds","colors","legend","show","min","max","avg","current","total","maxDataPoints","mappingType","nullPointMode","format","valueMaps","op","text","mode","groups","key","colorByFunction","sizeByFunction","enableTimeBlocks","enableGrouping","debug","depth","ids","nodeSizeProperty","HeatmapCtrl","$scope","$injector","$sce","defaults","panel","options","chartId","id","containerDivId","events","on","onInitEditMode","bind","onDataReceived","initializePanel","d3plusPath","_this","meta","SystemJS","config","import","then","d3plusLoaded","console","log","emit","err","getPanelContainer","html","addEditorTab","$","document","getElementById","dataList","info","undefined","series","map","seriesHandler","preparedData","d3plusDataProcessor","render","group","dataArray","resultArray","hasGroups","dataIndex","newDataItem","Object","assign","stats","groupArray","groupIndex","regex","stringToJsRegex","matches","alias","match","timeBlockArray","dataSeries","dataPointIndex","flotpairs","dataSeriesCopy","datapoints","count","timestamp","seriesData","target","getFlotPairs","override","without","thresholdCount","colorCount","refresh","colorIndex","splice","Math","apply","absoluteDistance","valueDistanceFromMin","seriesItemAlias","seriesItem","colorData","overrides","i","strVale","Number","trim","colorMap","valueName","reverse","pos","idString","scope","elem","attrs","ctrl","chartElement","find","append","chartContainer","css","height","gradientValueMax","gradientValueMin","visFormat","opts","timestampFormat","getGroupKeys","d3plus","string","title","updateSize","updateCanvasStyle","updateChart","clientWidth","canvasContext","clearRect","grd","createLinearGradient","colorWidth","currentColor","addColorStop","fillStyle","fillRect","innerText","getVisSize","dataPoint","getVisColor","rgbColor","getGradientForValue","hexColor","d3","select","selectAll","remove","idKeys","Array","from","aggs","aggregationFunction","viz","dev","container","showLegend","type","uniq","size","draw","onRender","renderingCompleted","templateUrl"],"mappings":"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","file":"heatmapControl.js","sourcesContent":["import './libs/d3/d3'; \r\nimport TimeSeries from 'app/core/time_series2';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {heatmapEditor, displayEditor, pluginName} from './properties';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport './series_overrides_heatmap_ctrl';\r\nimport './css/heatmap.css!';\r\n\r\nconst panelOptions = {\r\n\taggregationFunctions: ['avg', 'min', 'max', 'total', 'current', 'count'],\r\n\ttreeMap:{\r\n    \tmodes: ['squarify', 'slice', 'dice', 'slice-dice'],\r\n    \taggregationFunctions: ['sum', 'min', 'max', 'extent', 'mean', 'median', 'quantile', 'variance', 'deviation'],\r\n    \ttimestampFormats: ['YYYY-MM-DDTHH', 'YYYY-MM-DDTHH:mm', 'YYYY-MM-DDTHH:mm:ss', 'YYYY-MM-DDTHH:mm:ss.sssZ']\r\n\t}\r\n};\r\n\r\nconst panelDefaults = {\r\n\t// other style overrides\r\n    seriesOverrides: [],\r\n\tthresholds: '0,10',\r\n\tcolors: ['rgba(50, 172, 45, 1)', 'rgba(241, 255, 0, 1)', 'rgba(245, 54, 54, 1)'],\r\n\tlegend: {\r\n\t\tshow: true,\r\n\t\tmin: true,\r\n\t\tmax: true,\r\n\t\tavg: true,\r\n\t\tcurrent: true,\r\n\t\ttotal: true\r\n\t},\r\n\tmaxDataPoints: 100,\r\n\tmappingType: 1,\r\n\tnullPointMode: 'connected',\r\n\tformat: 'none',\r\n    valueMaps: [\r\n      { value: 'null', op: '=', text: 'N/A' }\r\n    ],\r\n    treeMap: {\r\n    \tmode: 'squarify',\r\n    \tgroups: [{key:'server', value: '/^.*\\./g'}],\r\n    \tcolorByFunction: 'max',\r\n    \tsizeByFunction: 'constant',\r\n    \tenableTimeBlocks: false,\r\n    \tenableGrouping: true,\r\n    \tdebug: false,\r\n    \tdepth: 0,\r\n    \tids: ['alias'],\r\n    \tnodeSizeProperty: \"value\"\r\n    }\r\n};\r\n\r\nclass HeatmapCtrl extends MetricsPanelCtrl {\r\n\tconstructor($scope, $injector, $sce) {\r\n\t\tsuper($scope, $injector);\r\n\t\t_.defaults(this.panel, panelDefaults);\r\n\t\t\r\n\t\tthis.options = panelOptions;\r\n\t\tthis.panel.chartId = 'chart_' + this.panel.id;\r\n\t\tthis.containerDivId = 'container_'+this.panel.chartId;\r\n\t\tthis.$sce = $sce;\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n\t\tthis.initializePanel();\r\n\t}\r\n\t\r\n\tinitializePanel(){\r\n\t\tvar d3plusPath = 'plugins/'+pluginName+'/libs/d3plus/d3plus.full.js';\r\n\t\tvar _this = this;\r\n\t\tvar meta = {};\r\n\t\tmeta[d3plusPath] = {\r\n\t\t\t      format: 'global'\r\n\t    };\r\n\t\t\r\n\t\tSystemJS.config({\r\n\t\t\t  meta: meta\r\n\t\t\t});\r\n\r\n\t\tSystemJS.import(d3plusPath).then(function d3plusLoaded(){\r\n\t\t\tconsole.log('d3plus is loaded');\r\n\t\t\t_this.events.emit('data-received');\r\n\t\t});\r\n\t}\r\n\t\r\n\thandleError(err){\r\n\t\tthis.getPanelContainer().html('<p>Error:</p><pre>' + err + '</pre>');\r\n\t}\r\n\t\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Heatmap', heatmapEditor, 2);\r\n\t\tthis.addEditorTab('Display', displayEditor, 3);\r\n\t}\r\n\t\r\n\tgetPanelContainer(){\r\n\t\treturn $(document.getElementById(this.containerDivId));\r\n\t}\r\n\t\r\n\tonDataReceived(dataList){\r\n\t\tconsole.info('received data');\r\n\t\tconsole.debug(dataList);\r\n\t\tif(undefined != dataList) {\r\n\t\t\tthis.series = dataList.map(this.seriesHandler.bind(this));\r\n\t\t\tconsole.info('mapped dataList to series');\r\n\t\t}\r\n\r\n\t\tvar preparedData = this.d3plusDataProcessor(this.series);\r\n\t\tthis.render(preparedData);\r\n\t}\r\n\t\r\n\tgetGroupKeys(){\r\n\t\treturn this.panel.treeMap.groups.map(function(group){\r\n\t\t\treturn group.key;\r\n\t\t});\r\n\t}\r\n\t\r\n\t/**\r\n\t * Prepare data for d3plus\r\n\t */\r\n\td3plusDataProcessor(dataArray){\r\n\t\tvar resultArray = [];\r\n\t\tvar hasGroups = (this.panel.treeMap.groups.length > 0)\r\n\t\t\r\n\t\tif(!hasGroups){\r\n\t\t\t// just add the original items since there are no groups\r\n\t\t\tfor (var dataIndex=0; dataIndex < dataArray.length; dataIndex++){\r\n\t\t\t\tvar newDataItem = Object.assign({}, dataArray[dataIndex], dataArray[dataIndex].stats);\r\n\t\t\t\tresultArray.push(newDataItem);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Process Groups\r\n\t\t\tvar groupArray = [];\r\n\t\t\tfor(var groupIndex=0; groupIndex<this.panel.treeMap.groups.length; groupIndex++){\r\n\t\t\t\tgroupArray.push({\r\n\t\t\t\t\tkey: this.panel.treeMap.groups[groupIndex].key,\r\n\t\t\t\t\tregex: kbn.stringToJsRegex(this.panel.treeMap.groups[groupIndex].value)\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tfor (var dataIndex=0; dataIndex < dataArray.length; dataIndex++){\r\n\t\t\t\tvar newDataItem = Object.assign({}, dataArray[dataIndex]);\r\n\t\t\t\t// only add the stats if we arent using granular timeblock data\r\n\t\t\t\tif(!this.panel.treeMap.enableTimeBlocks){\r\n\t\t\t\t\tObject.assign(newDataItem, dataArray[dataIndex].stats);\r\n\t\t\t\t}\r\n\t\t\t\tdelete newDataItem.stats;\r\n\t\t\t\t\r\n\t\t\t\tfor(var groupIndex=0; groupIndex < groupArray.length; groupIndex++){\r\n\t\t\t\t\tvar key = groupArray[groupIndex].key;\r\n\t\t\t\t\tvar regex = groupArray[groupIndex].regex;\r\n\t\t\t\t\tvar matches = newDataItem.alias.match(regex);\r\n\t\t\t\t\tif (matches && matches.length > 0){\r\n\t\t\t\t\t\tnewDataItem[key] = matches[0];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tnewDataItem[key] = 'NA';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tresultArray.push(newDataItem);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t\r\n\t\t// If we're using timeBlocks mode\r\n\t\t// replace the aggregated series with individual records\r\n\t\tif(this.panel.treeMap.enableTimeBlocks){\r\n\t\t\tconsole.info('creating timeblock records')\r\n\t\t\tvar timeBlockArray = [];\r\n\t\t\tfor (var dataIndex=0; dataIndex < resultArray.length; dataIndex++){\r\n\t\t\t\tconsole.debug('dataIndex:'+dataIndex+', alias:'+resultArray[dataIndex].alias);\r\n\t\t\t\tvar dataSeries = resultArray[dataIndex];\r\n\t\t\t\tfor(var dataPointIndex=0; dataPointIndex < dataSeries.flotpairs.length; dataPointIndex++){\r\n\t\t\t\t\tvar dataSeriesCopy = Object.assign({}, dataSeries);\r\n\t\t\t\t\tdelete dataSeriesCopy.datapoints;\r\n\t\t\t\t\tdelete dataSeriesCopy.flotpairs;\r\n\t\t\t\t\tdataSeriesCopy.count = 1;\r\n\t\t\t\t\tdataSeriesCopy.timestamp = dataSeries.flotpairs[dataPointIndex][0];\r\n\t\t\t\t\tdataSeriesCopy.value = dataSeries.flotpairs[dataPointIndex][1];\r\n\t\t\t\t\ttimeBlockArray.push(dataSeriesCopy);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tresultArray = timeBlockArray;\r\n\t\t} \r\n\t\t\r\n\t\treturn resultArray;\r\n\t}\r\n\t\r\n\t/**\r\n\t * Series Handler\r\n\t */\r\n\tseriesHandler(seriesData) {\r\n\t\tvar series = new TimeSeries({\r\n\t\t\tdatapoints: seriesData.datapoints,\r\n\t\t\talias: seriesData.target.replace(/\"|,|;|=|:|{|}/g, '_')\r\n\t\t});\r\n\t    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n\t    return series;\r\n\t} // End seriesHandler()\r\n\t\r\n\taddSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides.push(override || {});\r\n\t}\r\n\t\r\n\taddTreeMapGroup(group) {\r\n\t\tthis.panel.treeMap.groups.push(group || {});\r\n\t}\r\n\r\n\tremoveSeriesOverride(override) {\r\n\t\tthis.panel.seriesOverrides = _.without(this.panel.seriesOverrides, override);\r\n\t    this.render();\r\n\t}\r\n\t\r\n\tremoveTreeMapGroup(group) {\r\n\t\tthis.panel.treeMap.groups = _.without(this.panel.treeMap.groups, group);\r\n\t    this.render();\r\n\t}\r\n\t\r\n\tupdateThresholds(){\r\n\t\tvar thresholdCount = this.panel.thresholds.length;\r\n\t\tvar colorCount = this.panel.colors.length;\r\n\t\tthis.refresh();\r\n\t}\r\n\t\r\n\tchangeColor(colorIndex, color){\r\n\t\tthis.panel.colors[colorIndex] = color;\r\n\t}\r\n\t\r\n\tremoveColor(colorIndex){\r\n\t\tthis.panel.colors.splice(colorIndex,1);\r\n\t}\r\n\t\r\n\taddColor(){\r\n\t\tthis.panel.colors.push('rgba(255, 255, 255, 1)');\r\n\t}\r\n\t\r\n\tgetGradientForValue(data, value){\r\n\t\tvar min = Math.min.apply(Math, data.thresholds);\r\n\t\tvar max = Math.max.apply(Math, data.thresholds);\r\n\t\tvar absoluteDistance = max - min;\r\n\t\tvar valueDistanceFromMin = value - min;\r\n\t\tvar xPercent = valueDistanceFromMin/absoluteDistance;\r\n\t\t// Get the smaller number to clamp at 0.99 max\r\n\t\txPercent = Math.min(0.99, xPercent);\r\n\t\t// Get the larger number to clamp at 0.01 min\r\n\t\txPercent = Math.max(0.01, xPercent);\r\n\t\t\r\n\t\treturn getColorByXPercentage(this.canvas, xPercent);\r\n\t}\r\n\t\r\n\tapplyOverrides(seriesItemAlias){\r\n\t\tvar seriesItem = {}, colorData = {}, overrides = {};\r\n\t\tconsole.info('applying overrides for seriesItem');\r\n\t\tconsole.debug(seriesItemAlias);\r\n\t\tconsole.debug(this.panel.seriesOverrides);\r\n\t\tfor(var i=0; i<=this.panel.seriesOverrides.length; i++){\r\n\t\t\tconsole.debug('comparing:');\r\n\t\t\tconsole.debug(this.panel.seriesOverrides[i]);\r\n\t\t\tif (this.panel.seriesOverrides[i] && this.panel.seriesOverrides[i].alias == seriesItemAlias){\r\n\t\t\t\toverrides = this.panel.seriesOverrides[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\tcolorData.thresholds = (overrides.thresholds || this.panel.thresholds).split(',').map(function(strVale) {\r\n\t\t\treturn Number(strVale.trim());\r\n\t\t});\r\n\t\tcolorData.colorMap = this.panel.colors;\r\n\t\tseriesItem.colorData = colorData;\r\n\t\t\r\n\t\tseriesItem.valueName = overrides.valueName || this.panel.valueName;\r\n\t\t\r\n\t\treturn seriesItem;\r\n\t}\r\n\t\r\n\tinvertColorOrder() {\r\n\t    this.panel.colors.reverse();\r\n\t    this.refresh();\r\n\t}\r\n\t\r\n\taddTreeMapId(){\r\n\t\tthis.panel.treeMap.ids.push('');\r\n\t\tthis.refresh();\r\n\t}\r\n\t\r\n\tremoveTreeMapId(pos){\r\n\t\tthis.panel.treeMap.ids.splice(pos,1);\r\n\t\tthis.refresh();\r\n\t}\r\n\t\r\n\tchangeTreeMapId(idString, pos){\r\n\t\tthis.panel.treeMap.ids[pos] = idString;\r\n\t}\r\n\t\r\n\t// #############################################\r\n\t// link \r\n\t// #############################################\r\n\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t\tvar chartElement = elem.find('.heatmap');\r\n\t\tchartElement.append('<div id=\"'+ctrl.containerDivId+'\"></div>');\r\n\t    var chartContainer = $(document.getElementById(ctrl.containerDivId));\r\n    \tconsole.debug('found chartContainer');\r\n    \tconsole.debug(chartContainer);\r\n    \telem.css('height', ctrl.height + 'px');\r\n    \t\r\n    \tvar canvas = elem.find('.canvas')[0];\r\n\t    ctrl.canvas = canvas;\r\n\t    var gradientValueMax = elem.find('.gradient-value-max')[0];\r\n\t    var gradientValueMin = elem.find('.gradient-value-min')[0];\r\n\t    \r\n\r\n    \tvar visFormat =\r\n\t\t{ \r\n\t\t\t\"text\" : function(text, opts) {\r\n\t\t\t\tif(opts.key == 'timestamp'){\r\n\t\t\t\t\tvar timestamp = moment(Number(text));\r\n\t\t\t\t\treturn timestamp.format(ctrl.panel.treeMap.timestampFormat);\r\n\t\t\t\t} \r\n\t\t\t\telse if(ctrl.getGroupKeys().indexOf(opts.key)>-1) {\r\n\t\t\t\t\treturn text;\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\treturn d3plus.string.title(text, opts);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n    \t\r\n\r\n    \tfunction render(data){\r\n    \t\tupdateSize();\r\n    \t\tupdateCanvasStyle();\r\n    \t\tupdateChart(data);\r\n    \t}\r\n    \t\r\n    \tfunction updateCanvasStyle(){\r\n\t    \tcanvas.width = Math.max(chartElement[0].clientWidth, 100);\r\n\t\t\tvar canvasContext = canvas.getContext(\"2d\");\r\n\t\t\tcanvasContext.clearRect(0, 0, canvas.width, canvas.height);\r\n\t\t\t\r\n\t\t\tvar grd = canvasContext.createLinearGradient(0, 0, canvas.width, 0);\r\n\t\t\tvar colorWidth = 1 / Math.max(ctrl.panel.colors.length, 1);\r\n\t\t\tfor(var i=0; i<ctrl.panel.colors.length; i++){\r\n\t\t\t\tvar currentColor = ctrl.panel.colors[i];\r\n\t\t\t\tgrd.addColorStop(Math.min(colorWidth*i,1), currentColor);\r\n\t\t\t}\r\n\t\t\tcanvasContext.fillStyle = grd;\r\n\t\t\tcanvasContext.fillRect(0, 0, canvas.width, 3);\r\n    \t\tctrl.canvasContext = canvasContext;\r\n    \t\t\r\n\t\t\tgradientValueMax.innerText = Math.max.apply(Math, ctrl.panel.thresholds.split(','));\r\n\t\t\tgradientValueMin.innerText = Math.min.apply(Math, ctrl.panel.thresholds.split(','));\r\n    \t}\r\n    \t\r\n    \tfunction updateSize(){\r\n    \t\telem.css('height', ctrl.height + 'px');\r\n    \t}\r\n    \t\r\n    \tfunction getVisSize(dataPoint){\r\n    \t\tif(ctrl.panel.treeMap.sizeByFunction == 'constant') return 1;\r\n    \t\telse {\r\n        \t\treturn dataPoint[ctrl.panel.treeMap.sizeByFunction] || dataPoint.value;\r\n    \t\t}\r\n    \t}\r\n    \t\r\n    \tfunction getVisColor(dataPoint){\r\n    \t\tvar value = dataPoint[ctrl.panel.treeMap.colorByFunction] || dataPoint.value;\r\n    \t\tvar rgbColor = ctrl.getGradientForValue({thresholds: ctrl.panel.thresholds.split(',')}, value);\r\n\t\t\tvar hexColor = colorToHex(rgbColor);\r\n\t\t\treturn hexColor;\r\n    \t}\r\n    \t\r\n    \t\r\n    \tfunction updateChart(data){\r\n    \t\td3.select(\"#\"+ctrl.containerDivId).selectAll('*').remove();\r\n    \t\t\r\n    \t\t// Make sure the necessary IDs are added\r\n    \t\tvar idKeys = Array.from(ctrl.panel.treeMap.ids);\r\n    \t\tif(idKeys.length == 0){\r\n    \t\t\tensureArrayContains(idKeys, 'alias');\r\n    \t\t}\r\n    \t\tif(ctrl.panel.treeMap.enableTimeBlocks){\r\n    \t\t\tensureArrayContains(idKeys, 'timestamp');\r\n    \t\t}\r\n    \t\t\r\n    \t\t// Setup Aggregations \r\n    \t\tvar aggs = {};\r\n    \t\taggs.value = ctrl.panel.treeMap.aggregationFunction;\r\n    \t\taggs.current = ctrl.panel.treeMap.aggregationFunction;\r\n    \t\taggs.count = 'sum';\r\n    \t\taggs.total = 'sum';\r\n    \t\taggs.avg = 'mean';\r\n    \t\taggs.min = 'min';\r\n    \t\taggs.max = 'max';\r\n    \t\t\r\n    \t\td3plus.viz()\r\n\t\t\t\t.dev(ctrl.panel.treeMap.debug)\r\n    \t\t\t.aggs(aggs)\r\n    \t\t\t.container(\"#\"+ctrl.containerDivId)\r\n    \t\t\t.legend(ctrl.panel.treeMap.showLegend)\r\n    \t\t\t.data(data)\r\n    \t\t\t//.type(\"tree_map\")\r\n    \t\t\t.type({\"mode\": ctrl.panel.treeMap.mode})    // sets the mode of visualization display based on type    \r\n    \t\t\t.id({\r\n    \t\t\t\t\"value\": _.uniq(idKeys),\r\n    \t\t\t\t\"grouping\": ctrl.panel.treeMap.enableGrouping\r\n    \t\t\t})\r\n    \t\t\t.depth(Number(ctrl.panel.treeMap.depth))\r\n    \t\t\t.size(getVisSize)\r\n    \t\t\t.height(ctrl.height)\r\n    \t\t\t.width(ctrl.width)\r\n    \t\t\t.color(getVisColor)\r\n    \t\t\t.format(visFormat)\r\n    \t\t\t.draw();\r\n    \t}\r\n    \t\r\n    \t\r\n    \tthis.events.on('render', function onRender(data) {\r\n    \t\tif(typeof d3plus !== 'undefined' && data){\r\n    \t\t\trender(data);\r\n    \t\t\tctrl.renderingCompleted();\r\n    \t\t} else {\r\n    \t\t\tconsole.info('d3plus is not loaded yet');\r\n    \t\t}\r\n\t    });\r\n\t    \r\n\t}\r\n// End Class\r\n}\r\n\r\nfunction ensureArrayContains(array, value) {\r\n\tif (array.indexOf(value) == -1) {\r\n\t\tarray.push(value);\r\n\t}\r\n}\r\n\r\nfunction colorToHex(color) {\r\n    if (color.substr(0, 1) === '#') {\r\n        return color;\r\n    }\r\n    var digits = color.replace(/[rgba\\(\\)\\ ]/g,'').split(',');\r\n    while(digits.length < 3){\r\n    \tdigits.push(255);\r\n    }\r\n    \r\n    var red = parseInt(digits[0]);\r\n    var green = parseInt(digits[1]);\r\n    var blue = parseInt(digits[2]);\r\n    \r\n    var rgba = blue | (green << 8) | (red << 16);\r\n    return '#' + rgba.toString(16);\r\n};\r\n\r\nfunction getColorByXPercentage(canvas, xPercent){\r\n\tvar x = canvas.width * xPercent || 0;\r\n\tvar context = canvas.getContext(\"2d\");\r\n    var p = context.getImageData(x, 1, 1, 1).data; \r\n    var color = 'rgba('+[p[0] +','+ p[1] +','+ p[2] +','+ p[3]]+')';\r\n    return color;\r\n}\r\n\r\nHeatmapCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n\tHeatmapCtrl,\r\n\tHeatmapCtrl as MetricsPanelCtrl\r\n};\r\n"]}